<!DOCTYPE html>
<html lang="pt-BR">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <script src="../js/htmx.min.js"></script>
        <script src="../js/client-side-templates.min.js"></script>
        <script src="../js/mustache.min.js"></script>

        <link rel="stylesheet" href="../css/style.css">
        <link rel="stylesheet" href="../css/dialog.css">

        <title>Tabela de Presença</title>
    </head>

    <body>
        <div class="container">
            <div class="card">
                <div class="header">
                    <h1>Frequência Semanal do NCC</h1>
                    <img class="login" src="../images/exit.png" onclick="event.preventDefault(); logout();" alt="exit">
                </div>

                <div class="input-group">
                    <input type="text" id="new-person" placeholder="Nome do participante">
                    <input type="text" id="new-person-phone" placeholder="Telefone">
                    <button class="btn primary" onclick="addPerson()">
                        <span>
                            <img class="login" src="../images/plus.png">
                        </span>
                        <span class="btn-label">
                            Adicionar
                        </span>
                    </button>
                </div>

                <div class="navigation">
                    <div class="weeks">
                        <div>
                            <label>Semana:</label>
                            <input type="number" id="current-week" min="1" max="53" onchange="rebuild()">
                            <div class="btns-weeks">
                                <button class="btn primary" onclick="rebuild()">Seleciona Semana</button>
                                <button class="btn primary" onclick="setCurrentWeek()">Semana Atual</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="loading">
                    <img class="htmx-indicator" src="../icons/spinner.svg" alt="loadding">
                </div>

                <div hx-ext="client-side-templates">

                    <div id="result">
                        <!-- Os dados vão ser exibidos aqui. -->
                    </div>

                    <template id="presences-matrix">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <!-- {{#heads}} -->
                                    <th id="S{{.}}">{{.}}</th>
                                    <!-- {{/heads}} -->
                                </tr>
                            </thead>

                            <tbody>

                                <!-- {{#presences}} -->
                                <tr>
                                    <td class="person-name" data-person-id="{{personId}}"
                                        onclick="showPersonDialog(event)">{{name}}</td>

                                    <!-- {{#weekData}} -->
                                    <td class="">
                                        {{#present}}
                                            <button class="presence present {{#isCurrent}}current-week{{/isCurrent}}"
                                                data-person-id="{{personId}}" data-week="{{week}}"
                                                onclick="updatePresence(event)">✓</button>
                                        {{/present}}
                                        {{^present}}
                                            <button class="presence absent {{#isCurrent}}current-week{{/isCurrent}}"
                                                data-person-id="{{ personId}}" data-week="{{ week }}"
                                                onclick="updatePresence(event)">&nbsp;</button>
                                        {{/present}}
                                    </td>
                                    <!-- {{/weekData}} -->

                                </tr>
                                <!-- {{/presences}} -->

                            </tbody>

                            <tfoot>
                                <tr class="total-cell">
                                    <td class="total-cell">Total</td>

                                    <!-- {{#weekTotals}} -->
                                    <td>
                                        <div class="total-present">✔ {{present}}</div>
                                        <div><small>{{percent}}%</small></div>
                                    </td>
                                    <!-- {{/weekTotals}} -->

                                </tr>

                                <tr>
                                    <td class="summary">Resumo</td>
                                    <td colspan="{{weeks.length}}">
                                        <!-- {{#summary }} -->
                                        <div class="summary">
                                            <div class="light">
                                                Participantes: {{totalPersons}}
                                            </div>
                                            <div>
                                                Presenças: {{totalPresent}}
                                            </div>
                                            <div class="light">
                                                Ausências: {{totalAbsent}}
                                            </div>
                                        </div>
                                        <!-- {{/summary }} -->
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </template>
                </div>
            </div>

            <div class="instructions">
                <h2 id="h2-title">Instruções:</h2>
                <ul>
                    <li>• Adicione participantes usando o campo acima</li>
                    <li>• Clique nas células para marcar presença (verde) ou ausência (cinza)</li>
                    <li>• Use "Selecionar semana" para navegar pelas 52 semanas</li>
                    <li>• Apenas a semana atual (destacada com ★) pode ser editada</li>
                    <li>• A linha "Total" mostra a soma de participantes presentes em cada semana</li>
                </ul>
            </div>
        </div>

        <dialog id="person-details" class="dialog">
            <!-- Detalhes do participante aqui -->
        </dialog>

        <template id="details-template">
            <article class="article">
                <header>
                    <span onclick="closePersonDialog()">×</span>
                </header>

                <div class="dlg-body">
                    <div class="person-header">
                        {{#person}}
                            <div class="person-avatar">{{initials}}</div>
                            <div class="person-info">
                                <h3>{{name}}</h3>
                                <p>Fone: {{formatedPhone}}</p>
                                <p>Fone: {{phone}}</p>
                            </div>
                        {{/person}}
                    </div>
                    <div class="details">
                        <div class="">
                            <span class="detail-label">Presenças:</span>
                            <span class="detail-value">{{qtdWeeks}} participações nas últimas semanas</span>
                        </div>
                    </div>
                    <div class="presence-history">
                        <div class="detail-label">Histórico por Semana:</div>
                        <div class="presence-list">
                            {{#presences}}
                                <span class="week-badge {{#present}}present{{/present}}{{^present}}absent{{/present}}">
                                    {{week}}
                                    {{#present}}✓{{/present}}{{^present}}✗{{/present}}
                                </span>
                            {{/presences}}
                        </div>
                    </div>
                </div>
            </article>
        </template>

        <div id="toast">
            <span id="message">
                <!-- Mensagem de notificação -->
            </span>
        </div>

        <div id="empty-state" style="display: none;">
            Adicione participantes para começar o acompanhamento da frequência.
        </div>

        <script src="../js/auth.js"></script>
        <script>
            // Verifica autenticação antes de executar o script principal
            if (window.auth) {
                window.auth.requireLogin();
            }
        </script>
        <script src="../js/main.js"></script>
        <script src="../js/login.js"></script>
        <!-- <script src="../js/table.js"></script> -->
    </body>

</html>